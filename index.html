<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¶æ®ç”Ÿæˆå™¨</title>
    <style>
        @font-face {
            font-family: 'STXINGKA';
            src: url('fonts/STXINGKA.TTF') format('truetype');
            font-display: swap;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'SimHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            color: #333;
            margin-bottom: 5px;
        }

        .form {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #555;
            font-weight: 500;
        }

        .form-group input[type="text"],
        .form-group input[type="number"] {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s ease;
            font-family: 'Microsoft YaHei', 'SimHei', sans-serif;
        }

        .form-group input[type="text"]:focus,
        .form-group input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 2px dashed #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            background: #fafafa;
        }

        .form-group input[type="file"]:hover {
            border-color: #667eea;
            background: #f0f0f0;
        }

        .preview {
            margin-top: 10px;
            max-width: 150px;
            max-height: 150px;
            border: 1px solid #ddd;
            border-radius: 5px;
            display: none;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .success {
            display: none;
            background: #4CAF50;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
            animation: slideIn 0.3s ease;
        }

        .error {
            display: none;
            background: #f44336;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .icon {
            margin-right: 5px;
        }

        .font-test {
            font-family: 'STXINGKA', 'SimHei', sans-serif;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            background: #fff3cd;
            border-radius: 10px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“„ æ”¶æ®ç”Ÿæˆå™¨</h1>
        </div>

        <div class="form">
            <div class="form-group">
                <label>ğŸ”¢ ç¼–å·</label>
                <input type="text" id="number" placeholder="è¯·è¾“å…¥ç¼–å·">
            </div>

            <div class="form-group">
                <label>ğŸ“… å…¥è´¦æ—¥æœŸ</label>
                <input type="text" id="date" placeholder="YYYYå¹´MMæœˆDDæ—¥">
            </div>

            <div class="form-group">
                <label>ğŸ¢ äº¤æ¬¾å•ä½</label>
                <input type="text" id="payer" placeholder="è¯·è¾“å…¥äº¤æ¬¾å•ä½">
            </div>

            <div class="form-group">
                <label>ğŸ’³ æ”¶æ¬¾æ–¹å¼</label>
                <input type="text" id="payment_method" placeholder="è¯·è¾“å…¥æ”¶æ¬¾æ–¹å¼">
            </div>

            <div class="form-group">
                <label>ğŸ’° é‡‘é¢ (å…ƒ)</label>
                <input type="number" id="amount" placeholder="0.00" step="0.01">
            </div>

            <div class="form-group">
                <label>ğŸ“ æ”¶æ¬¾äº‹ç”±</label>
                <input type="text" id="reason" placeholder="è¯·è¾“å…¥æ”¶æ¬¾äº‹ç”±">
            </div>

            <div class="form-group">
                <label>ğŸ‘¨â€ğŸ’¼ è´¢ä¼šä¸»ç®¡</label>
                <input type="text" id="accountant" placeholder="è¯·è¾“å…¥è´¢ä¼šä¸»ç®¡">
            </div>

            <div class="form-group">
                <label>ğŸ“’ è®°è´¦</label>
                <input type="text" id="bookkeeper" placeholder="è¯·è¾“å…¥è®°è´¦äºº">
            </div>

            <div class="form-group">
                <label>ğŸ’µ å‡ºçº³</label>
                <input type="text" id="cashier" placeholder="è¯·è¾“å…¥å‡ºçº³äºº">
            </div>

            <div class="form-group">
                <label>âœ… å®¡æ ¸</label>
                <input type="text" id="auditor" placeholder="è¯·è¾“å…¥å®¡æ ¸äºº">
            </div>

            <div class="form-group">
                <label>ğŸ–‹ï¸ ç»åŠ</label>
                <input type="text" id="handler" placeholder="è¯·è¾“å…¥ç»åŠäºº">
            </div>

            <div class="form-group">
                <label>ğŸ·ï¸ å•ä½ç›–ç«  (å¯é€‰)</label>
                <input type="file" id="stamp" accept="image/*" onchange="previewStamp(this)">
                <img id="stampPreview" class="preview" alt="ç›–ç« é¢„è§ˆ">
            </div>

            <button class="btn" onclick="generateReceipt()" id="generateBtn">âœ¨ ç”Ÿæˆæ”¶æ®</button>

            <div id="success" class="success"></div>
            <div id="error" class="error"></div>
        </div>
    </div>

    <script>
        let fontBase64 = null;
        let stampBase64 = null;

        async function loadFontAsBase64() {
            const loadingDiv = document.getElementById('loading');
            const generateBtn = document.getElementById('generateBtn');
            
            loadingDiv.style.display = 'block';
            generateBtn.disabled = true;
            generateBtn.textContent = 'æ­£åœ¨åŠ è½½å­—ä½“...';

            try {
                const response = await fetch('fonts/STXINGKA.TTF');
                if (!response.ok) {
                    throw new Error('æ— æ³•åŠ è½½å­—ä½“æ–‡ä»¶');
                }
                const arrayBuffer = await response.arrayBuffer();
                const blob = new Blob([arrayBuffer], { type: 'font/ttf' });
                fontBase64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
                
                loadingDiv.style.display = 'none';
                generateBtn.disabled = false;
                generateBtn.textContent = 'âœ¨ ç”Ÿæˆæ”¶æ®';
                
                const fontTest = document.getElementById('fontTest');
                fontTest.textContent = 'âœ… STXINGKAå­—ä½“åŠ è½½æˆåŠŸ';
                fontTest.style.background = '#d4edda';
                fontTest.style.color = '#155724';
            } catch (error) {
                console.error('åŠ è½½å­—ä½“å¤±è´¥:', error);
                loadingDiv.style.display = 'none';
                generateBtn.disabled = false;
                generateBtn.textContent = 'âœ¨ ç”Ÿæˆæ”¶æ®ï¼ˆä½¿ç”¨é»˜è®¤å­—ä½“ï¼‰';
                
                const fontTest = document.getElementById('fontTest');
                fontTest.textContent = 'âš ï¸ å­—ä½“åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨é»˜è®¤å­—ä½“';
                fontTest.style.background = '#fff3cd';
                fontTest.style.color = '#856404';
            }
        }

        function previewStamp(input) {
            const preview = document.getElementById('stampPreview');
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    stampBase64 = e.target.result;
                };
                
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.style.display = 'none';
                stampBase64 = null;
            }
        }

        function numberToChinese(num) {
            const chineseNums = ['é›¶', 'å£¹', 'è´°', 'å', 'è‚†', 'ä¼', 'é™†', 'æŸ’', 'æŒ', 'ç–'];
            const chineseUnits = ['', 'æ‹¾', 'ä½°', 'ä»Ÿ', 'ä¸‡', 'æ‹¾', 'ä½°', 'ä»Ÿ', 'äº¿'];
            
            try {
                const numFloat = parseFloat(num);
                if (numFloat === 0) {
                    return 'é›¶å…ƒæ•´';
                }
                
                const integerPart = Math.floor(numFloat);
                const decimalPart = Math.round((numFloat - integerPart) * 100);
                
                let result = '';
                
                if (integerPart === 0) {
                    result = 'é›¶';
                } else {
                    const numStr = integerPart.toString();
                    const length = numStr.length;
                    
                    for (let i = 0; i < length; i++) {
                        const digitInt = parseInt(numStr[i]);
                        const pos = length - i - 1;
                        
                        if (digitInt !== 0) {
                            result += chineseNums[digitInt] + chineseUnits[pos];
                        } else {
                            if (i < length - 1 && parseInt(numStr[i + 1]) !== 0) {
                                result += chineseNums[0];
                            }
                        }
                    }
                }
                
                result += 'å…ƒ';
                
                if (decimalPart > 0) {
                    const jiao = Math.floor(decimalPart / 10);
                    const fen = decimalPart % 10;
                    
                    if (jiao > 0) {
                        result += chineseNums[jiao] + 'è§’';
                    }
                    if (fen > 0) {
                        result += chineseNums[fen] + 'åˆ†';
                    }
                } else {
                    result += 'æ•´';
                }
                
                return result;
            } catch (e) {
                return 'é›¶å…ƒæ•´';
            }
        }

        function getSVGTemplate() {
            const fontFace = fontBase64 
                ? `@font-face {
        font-family: 'STXINGKA';
        src: url('${fontBase64}') format('truetype');
      }`
                : '';
            
            return `<?xml version="1.0" encoding="UTF-8"?>
<svg id="_å›¾å±‚_1" data-name="å›¾å±‚ 1" xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 566.93 283.46">
  <defs>
    <style>
      .cls-1 {
        stroke-width: 0px;
      }

      .cls-1, .cls-2, .cls-3, .cls-4, .cls-5, .cls-6, .cls-7, .cls-8, .cls-9 {
        fill: #000;
      }

      .cls-2 {
        font-size: 10px;
      }

      .cls-2, .cls-4, .cls-5, .cls-8 {
        font-family: KaiTi, KaiTi;
      }

      .cls-10 {
        stroke-width: .4px;
      }

      .cls-10, .cls-3, .cls-11, .cls-7 {
        stroke: #000;
        stroke-miterlimit: 10;
      }

      .cls-10, .cls-11 {
        fill: none;
      }

      .cls-12, .cls-13, .cls-6 {
        font-size: 11px;
      }

      .cls-3 {
        stroke-width: .25px;
      }

      .cls-4 {
        font-size: 20px;
      }

      .cls-13 {
        letter-spacing: -.25em;
      }

      .cls-5, .cls-9, .cls-14 {
        font-size: 18px;
      }

      .cls-6 {
        glyph-orientation-vertical: 0deg;
        text-orientation: upright;
        writing-mode: tb;
      }

      .cls-6, .cls-9 {
        font-family: STKaiti, STKaiti;
      }

      .cls-7 {
        stroke-width: .5px;
      }

      .cls-15 {
        letter-spacing: 0em;
      }
      ${fontFace}
      .cls-new {
        fill: #000;
        font-size: 9px;
        font-family: 'STXINGKA', 'SimHei', sans-serif;
      }
    </style>
  </defs>
  <text class="cls-4" transform="translate(228.46 49.28)"><tspan x="0" y="0" xml:space="preserve">æ”¶       æ®</tspan></text>
  <line class="cls-10" x1="212.25" y1="56.69" x2="354.68" y2="56.69"/>
  <line class="cls-10" x1="212.25" y1="53.86" x2="354.68" y2="53.86"/>
  <g>
    <path class="cls-1" d="M410.85,42.33c-1.28.14-1.7.34-1.76,1.26-.02.64-.06,1.48-.06,3.34v8.02h-.76l-8.56-10.46v5c0,1.8.06,2.7.1,3.28.04,1.02.54,1.32,1.98,1.44v.56h-4.86v-.56c1.24-.1,1.72-.4,1.8-1.38.06-.64.1-1.54.1-3.36v-5.1c0-.56-.04-.88-.4-1.32-.38-.5-.8-.62-1.78-.72v-.56h3l8.48,10.06v-4.9c0-1.86-.04-2.72-.1-3.32-.06-.9-.52-1.18-2.12-1.28v-.56h4.94v.56Z"/>
    <path class="cls-1" d="M416.04,45.75c2.5,0,4.36,1.9,4.36,4.48,0,3.24-2.4,4.78-4.36,4.78-2.76,0-4.44-2.22-4.44-4.46,0-3.26,2.54-4.8,4.44-4.8ZM415.8,46.43c-1.22,0-2.32,1.18-2.32,3.5,0,2.54,1.12,4.38,2.76,4.38,1.24,0,2.28-.9,2.28-3.64,0-2.34-.96-4.24-2.72-4.24Z"/>
    <path class="cls-1" d="M422.68,54.1c0-.5.38-.92.88-.92s.9.42.9.92c0,.54-.38.9-.9.9-.56-.02-.88-.4-.88-.9Z"/>
  </g>
  <text class="cls-2" transform="translate(213.46 74.24)"><tspan x="0" y="0" xml:space="preserve">å…¥è´¦æ—¥æœŸï¼š    å¹´    æœˆ    æ—¥</tspan></text>
  <rect class="cls-11" x="35.43" y="85.04" width="496.06" height="113.39"/>
  <text class="cls-5" transform="translate(49.04 108.13)"><tspan x="0" y="0">äº¤æ¬¾å•ä½</tspan></text>
  <line class="cls-7" x1="128.21" y1="113.39" x2="308.33" y2="113.39"/>
  <text class="cls-5" transform="translate(306.99 108.13)"><tspan x="0" y="0">æ”¶æ¬¾æ–¹å¼</tspan></text>
  <line class="cls-7" x1="382.68" y1="113.39" x2="524.41" y2="113.39"/>
  <text class="cls-8" transform="translate(49.04 133.64)"><tspan class="cls-14" x="0" y="0">äºº æ°‘ å¸</tspan><tspan class="cls-12" x="72" y="0">(</tspan><tspan class="cls-13" x="77.5" y="0">å¤§å†™ </tspan><tspan class="cls-12" x="96.75" y="0">)</tspan></text>
  <text class="cls-9" transform="translate(355.51 131.92)"><tspan x="0" y="0">Â¥</tspan></text>
  <line class="cls-7" x1="155.91" y1="138.9" x2="340.16" y2="138.9"/>
  <line class="cls-3" x1="381.26" y1="134.65" x2="525.83" y2="134.65"/>
  <line class="cls-3" x1="381.26" y1="132.52" x2="525.83" y2="132.52"/>
  <line class="cls-3" x1="381.26" y1="130.39" x2="525.83" y2="130.39"/>
  <line class="cls-3" x1="381.26" y1="128.27" x2="525.83" y2="128.27"/>
  <path class="cls-3" d="M381.26,126.14h144.57-144.57Z"/>
  <line class="cls-3" x1="381.26" y1="124.02" x2="525.83" y2="124.02"/>
  <line class="cls-3" x1="381.26" y1="121.89" x2="525.83" y2="121.89"/>
  <line class="cls-3" x1="381.26" y1="119.76" x2="525.83" y2="119.76"/>
  <line class="cls-3" x1="381.26" y1="117.64" x2="525.83" y2="117.64"/>
  <text class="cls-5" transform="translate(49.04 159.15)"><tspan x="0" y="0">æ”¶æ¬¾äº‹ç”±</tspan></text>
  <line class="cls-7" x1="127.56" y1="164.41" x2="524.41" y2="164.41"/>
  <text class="cls-6" transform="translate(42.52 205.24)"><tspan x="0" y="0">å•ä½ç›–ç« </tspan></text>
  <text class="cls-6" transform="translate(283.4 205.24)"><tspan x="0" y="0">è´¢ä¼šä¸»ç®¡</tspan></text>
  <text class="cls-6" transform="translate(510.24 205.8)"><tspan x="0" y="0">ç»</tspan><tspan x="0" y="14.31" xml:space="preserve">          </tspan><tspan class="cls-15" x="0" y="41.81">åŠ</tspan></text>
  <text class="cls-6" transform="translate(340.16 205.8)"><tspan x="0" y="0">è®°</tspan><tspan x="0" y="14.31" xml:space="preserve">          </tspan><tspan class="cls-15" x="0" y="41.81">è´¦</tspan></text>
  <text class="cls-6" transform="translate(396.85 205.8)"><tspan x="0" y="0">å‡º</tspan><tspan x="0" y="14.31" xml:space="preserve">          </tspan><tspan class="cls-15" x="0" y="41.81">çº³</tspan></text>
  <text class="cls-6" transform="translate(453.54 205.8)"><tspan x="0" y="0">å®¡</tspan><tspan x="0" y="14.31" xml:space="preserve">          </tspan><tspan class="cls-15" x="0" y="41.81">æ ¸</tspan></text>
  <text class="cls-2" transform="translate(429.8 194.72)"><tspan x="0" y="0" xml:space="preserve">    å¹´    æœˆ    æ—¥</tspan></text>
</svg>`;
        }

        function generateReceipt() {
            const number = document.getElementById('number').value;
            const dateStr = document.getElementById('date').value;
            const payer = document.getElementById('payer').value;
            const paymentMethod = document.getElementById('payment_method').value;
            const amount = document.getElementById('amount').value;
            const reason = document.getElementById('reason').value;
            const accountant = document.getElementById('accountant').value;
            const bookkeeper = document.getElementById('bookkeeper').value;
            const cashier = document.getElementById('cashier').value;
            const auditor = document.getElementById('auditor').value;
            const handler = document.getElementById('handler').value;

            if (!dateStr) {
                showError('è¯·è¾“å…¥å…¥è´¦æ—¥æœŸ');
                return;
            }

            const chineseAmount = numberToChinese(amount);
            
            let svgContent = getSVGTemplate();
            
            svgContent = svgContent.replace('å…¥è´¦æ—¥æœŸï¼š    å¹´    æœˆ    æ—¥', `å…¥è´¦æ—¥æœŸï¼š${dateStr}`);
            
            svgContent = svgContent.replace(
                '<text class="cls-5" transform="translate(49.04 108.13)"><tspan x="0" y="0">äº¤æ¬¾å•ä½</tspan></text>',
                `<text class="cls-5" transform="translate(49.04 108.13)"><tspan x="0" y="0">äº¤æ¬¾å•ä½</tspan></text><text class="cls-new" transform="translate(130 108.13)"><tspan x="0" y="0">${payer}</tspan></text>`
            );
            
            svgContent = svgContent.replace(
                '<text class="cls-5" transform="translate(306.99 108.13)"><tspan x="0" y="0">æ”¶æ¬¾æ–¹å¼</tspan></text>',
                `<text class="cls-5" transform="translate(306.99 108.13)"><tspan x="0" y="0">æ”¶æ¬¾æ–¹å¼</tspan></text><text class="cls-new" transform="translate(385 108.13)"><tspan x="0" y="0">${paymentMethod}</tspan></text>`
            );
            
            svgContent = svgContent.replace(
                '<text class="cls-8" transform="translate(49.04 133.64)"><tspan class="cls-14" x="0" y="0">äºº æ°‘ å¸</tspan><tspan class="cls-12" x="72" y="0">(</tspan><tspan class="cls-13" x="77.5" y="0">å¤§å†™ </tspan><tspan class="cls-12" x="96.75" y="0">)</tspan></text>',
                `<text class="cls-8" transform="translate(49.04 133.64)"><tspan class="cls-14" x="0" y="0">äºº æ°‘ å¸</tspan><tspan class="cls-12" x="72" y="0">(</tspan><tspan class="cls-13" x="77.5" y="0">å¤§å†™ </tspan><tspan class="cls-12" x="96.75" y="0">)</tspan></text><text class="cls-new" transform="translate(160 133.64)"><tspan x="0" y="0">${chineseAmount}</tspan></text>`
            );
            
            svgContent = svgContent.replace(
                '<text class="cls-9" transform="translate(355.51 131.92)"><tspan x="0" y="0">Â¥</tspan></text>',
                `<text class="cls-9" transform="translate(355.51 131.92)"><tspan x="0" y="0">Â¥</tspan></text><text class="cls-new" transform="translate(385 131.92)"><tspan x="0" y="0">${amount}</tspan></text>`
            );
            
            svgContent = svgContent.replace(
                '<text class="cls-5" transform="translate(49.04 159.15)"><tspan x="0" y="0">æ”¶æ¬¾äº‹ç”±</tspan></text>',
                `<text class="cls-5" transform="translate(49.04 159.15)"><tspan x="0" y="0">æ”¶æ¬¾äº‹ç”±</tspan></text><text class="cls-new" transform="translate(130 159.15)"><tspan x="0" y="0">${reason}</tspan></text>`
            );
            
            svgContent = svgContent.replace(
                '<text class="cls-6" transform="translate(283.4 205.24)"><tspan x="0" y="0">è´¢ä¼šä¸»ç®¡</tspan></text>',
                `<text class="cls-6" transform="translate(283.4 205.24)"><tspan x="0" y="0">è´¢ä¼šä¸»ç®¡</tspan></text><text class="cls-new" transform="translate(310 225)"><tspan x="0" y="0">${accountant}</tspan></text>`
            );
            
            svgContent = svgContent.replace(
                '<text class="cls-6" transform="translate(340.16 205.8)"><tspan x="0" y="0">è®°</tspan><tspan x="0" y="14.31" xml:space="preserve">          </tspan><tspan class="cls-15" x="0" y="41.81">è´¦</tspan></text>',
                `<text class="cls-6" transform="translate(340.16 205.8)"><tspan x="0" y="0">è®°</tspan><tspan x="0" y="14.31" xml:space="preserve">          </tspan><tspan class="cls-15" x="0" y="41.81">è´¦</tspan></text><text class="cls-new" transform="translate(367 225)"><tspan x="0" y="0">${bookkeeper}</tspan></text>`
            );
            
            svgContent = svgContent.replace(
                '<text class="cls-6" transform="translate(396.85 205.8)"><tspan x="0" y="0">å‡º</tspan><tspan x="0" y="14.31" xml:space="preserve">          </tspan><tspan class="cls-15" x="0" y="41.81">çº³</tspan></text>',
                `<text class="cls-6" transform="translate(396.85 205.8)"><tspan x="0" y="0">å‡º</tspan><tspan x="0" y="14.31" xml:space="preserve">          </tspan><tspan class="cls-15" x="0" y="41.81">çº³</tspan></text><text class="cls-new" transform="translate(423 225)"><tspan x="0" y="0">${cashier}</tspan></text>`
            );
            
            svgContent = svgContent.replace(
                '<text class="cls-6" transform="translate(453.54 205.8)"><tspan x="0" y="0">å®¡</tspan><tspan x="0" y="14.31" xml:space="preserve">          </tspan><tspan class="cls-15" x="0" y="41.81">æ ¸</tspan></text>',
                `<text class="cls-6" transform="translate(453.54 205.8)"><tspan x="0" y="0">å®¡</tspan><tspan x="0" y="14.31" xml:space="preserve">          </tspan><tspan class="cls-15" x="0" y="41.81">æ ¸</tspan></text><text class="cls-new" transform="translate(480 225)"><tspan x="0" y="0">${auditor}</tspan></text>`
            );
            
            svgContent = svgContent.replace(
                '<text class="cls-6" transform="translate(510.24 205.8)"><tspan x="0" y="0">ç»</tspan><tspan x="0" y="14.31" xml:space="preserve">          </tspan><tspan class="cls-15" x="0" y="41.81">åŠ</tspan></text>',
                `<text class="cls-6" transform="translate(510.24 205.8)"><tspan x="0" y="0">ç»</tspan><tspan x="0" y="14.31" xml:space="preserve">          </tspan><tspan class="cls-15" x="0" y="41.81">åŠ</tspan></text><text class="cls-new" transform="translate(537 225)"><tspan x="0" y="0">${handler}</tspan></text>`
            );
            
            svgContent = svgContent.replace(
                '<text class="cls-2" transform="translate(429.8 194.72)"><tspan x="0" y="0" xml:space="preserve">    å¹´    æœˆ    æ—¥</tspan></text>',
                `<text class="cls-2" transform="translate(429.8 194.72)"><tspan x="0" y="0" xml:space="preserve">    ${dateStr.substring(0, 4)}å¹´${dateStr.substring(5, 7)}æœˆ${dateStr.substring(8, 10)}æ—¥</tspan></text>`
            );
            
            svgContent = svgContent.replace(
                '</svg>',
                `<text class="cls-new" transform="translate(430 50)"><tspan x="0" y="0">${number}</tspan></text>${stampBase64 ? `<image href="${stampBase64}" x="52" y="195" width="100" height="100" preserveAspectRatio="xMidYMid meet"/>` : ''}</svg>`
            );
            
            const timestamp = new Date().toISOString().replace(/[:.]/g, '').replace('T', '_').substring(0, 15);
            const filename = `receipt_${timestamp}.svg`;
            
            const blob = new Blob([svgContent], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            const fontStatus = fontBase64 ? 'ï¼ˆä½¿ç”¨STXINGKAå­—ä½“ï¼‰' : 'ï¼ˆä½¿ç”¨é»˜è®¤å­—ä½“ï¼‰';
            const stampStatus = stampBase64 ? 'ï¼ˆå·²æ·»åŠ ç›–ç« ï¼‰' : 'ï¼ˆæ— ç›–ç« ï¼‰';
            showSuccess(`æ”¶æ®å·²ç”Ÿæˆï¼š${filename} ${fontStatus} ${stampStatus}`);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('success');
            const errorDiv = document.getElementById('error');
            
            successDiv.textContent = `âœ… ${message}`;
            successDiv.style.display = 'block';
            errorDiv.style.display = 'none';
            
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 5000);
        }

        function showError(message) {
            const successDiv = document.getElementById('success');
            const errorDiv = document.getElementById('error');
            
            errorDiv.textContent = `âŒ ${message}`;
            errorDiv.style.display = 'block';
            successDiv.style.display = 'none';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        window.onload = function() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            document.getElementById('date').value = `${year}å¹´${month}æœˆ${day}æ—¥`;
            
            loadFontAsBase64();
        };
    </script>
</body>
</html>
